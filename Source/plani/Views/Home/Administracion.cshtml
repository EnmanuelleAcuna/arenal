@{
    ViewData["Title"] = "Administración";
    ViewBag.BreadcrumbIcon = "fa-tachometer-alt";
    ViewBag.Breadcrumbs = new[] { "Panel de administración" };
}

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon green">
            <i class="fas fa-building"></i>
        </div>
        <div class="stat-content">
            <h6>Clientes</h6>
            <p class="stat-value" id="statClientes">0</p>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon orange">
            <i class="fas fa-project-diagram"></i>
        </div>
        <div class="stat-content">
            <h6>Proyectos</h6>
            <p class="stat-value" id="statProyectos">0</p>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon blue">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
            <h6>Colaboradores</h6>
            <p class="stat-value" id="statColaboradores">0</p>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon purple">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-content">
            <h6>Sesiones Hoy</h6>
            <p class="stat-value" id="statSesionesHoy">0</p>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="charts-grid" style="position: relative;">
    <!-- Loading Overlay -->
    <div id="dashboardLoader" class="dashboard-loader">
        <div class="loader-spinner"></div>
    </div>

    <!-- Sesiones por Mes -->
    <div class="content-card">
        <h5><i class="fas fa-chart-bar text-primary"></i> Sesiones de trabajo</h5>
        <div class="chart-container">
            <canvas id="chartSesionesMes"></canvas>
        </div>
    </div>

    <!-- Horas Trabajadas -->
    <div class="content-card">
        <h5><i class="fas fa-chart-line text-success"></i> Horas trabajadas</h5>
        <div class="chart-container">
            <canvas id="chartHorasTrabajadas"></canvas>
        </div>
    </div>

    <!-- Distribución por Servicio -->
    <div class="content-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h5 style="margin: 0;"><i class="fas fa-chart-pie text-warning"></i> Horas por Servicio</h5>
            <select id="selectMesServicio" class="form-control form-control-sm" style="width: auto;">
                <option value="10">Octubre</option>
                <option value="11" selected>Noviembre</option>
                <option value="12">Diciembre</option>
            </select>
        </div>
        <div class="chart-container">
            <canvas id="chartDistribucionServicios"></canvas>
        </div>
    </div>

    <!-- Proyectos Activos vs Finalizados -->
    <div class="content-card">
        <h5><i class="fas fa-tasks text-info"></i> Proyectos por Estado</h5>
        <div class="chart-container">
            <canvas id="chartProyectosEstado"></canvas>
        </div>
    </div>

    <!-- Top 5 Clientes -->
    <div class="content-card">
        <h5><i class="fas fa-trophy text-warning"></i> Top 5 Clientes por Horas del Mes</h5>
        <div class="chart-container">
            <canvas id="chartTopClientes"></canvas>
        </div>
    </div>

    <!-- Top 5 Colaboradores por Horas -->
    <div class="content-card">
        <h5><i class="fas fa-chart-bar text-success"></i> Top 5 Colaboradores por Horas del Mes</h5>
        <div class="chart-container">
            <canvas id="chartUtilizacionColaboradores"></canvas>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Configuración de colores - Paleta profesional pastel
        const chartColors = {
            blue: { bg: 'rgba(100, 149, 237, 0.6)', border: 'rgba(65, 105, 225, 0.8)' },
            green: { bg: 'rgba(102, 187, 106, 0.6)', border: 'rgba(56, 142, 60, 0.8)' },
            orange: { bg: 'rgba(255, 167, 38, 0.6)', border: 'rgba(239, 108, 0, 0.8)' },
            purple: { bg: 'rgba(149, 117, 205, 0.6)', border: 'rgba(103, 58, 183, 0.8)' },
            teal: { bg: 'rgba(77, 182, 172, 0.6)', border: 'rgba(0, 137, 123, 0.8)' },
            pink: { bg: 'rgba(240, 98, 146, 0.6)', border: 'rgba(194, 24, 91, 0.8)' },
            amber: { bg: 'rgba(255, 202, 40, 0.6)', border: 'rgba(255, 160, 0, 0.8)' }
        };

        // Array de colores para asignar dinámicamente
        const colorArray = [
            chartColors.blue,
            chartColors.green,
            chartColors.purple,
            chartColors.orange,
            chartColors.teal,
            chartColors.pink,
            chartColors.amber
        ];

        // Configuraciones base para gráficos
        const baseOptions = {
            responsive: true,
            maintainAspectRatio: false
        };

        const doughnutLegend = {
            position: 'bottom',
            labels: { padding: 15, usePointStyle: true, pointStyle: 'circle' }
        };

        const percentageTooltip = (label, suffix = '') => ({
            label: function(context) {
                let text = context.label ? context.label + ': ' : '';
                text += context.parsed + suffix;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                return text + ' (' + percentage + '%)';
            }
        });

        // Variables globales para gráficos
        let chartSesionesMes = null;
        let chartHorasTrabajadas = null;
        let chartServiciosInstance = null;
        let chartProyectosEstado = null;
        let chartTopClientes = null;
        let chartTopColaboradores = null;
        let datosServiciosPorMes = {};

        // Cargar datos del dashboard
        async function cargarDatosDashboard() {
            const loader = document.getElementById('dashboardLoader');

            try {
                // Mostrar loader
                loader.classList.remove('hidden');

                const response = await fetch('/Home/ObtenerDatosDashboard');

                if (!response.ok) {
                    throw new Error('Error al cargar datos del dashboard');
                }

                const datos = await response.json();

                // Actualizar stats del header
                actualizarStats(datos.stats);

                // Crear gráficos
                crearGraficoSesionesPorMes(datos.sesionesPorMes);
                crearGraficoHorasPorMes(datos.horasPorMes);
                crearGraficoProyectosPorEstado(datos.proyectosPorEstado);
                crearGraficoTopClientes(datos.topClientes);
                crearGraficoTopColaboradores(datos.topColaboradores);

                // Guardar datos de servicios por mes para el selector
                datosServiciosPorMes = datos.horasPorServicioPorMes;

                // Crear selector de meses dinámicamente
                crearSelectorMeses(datos.horasPorServicioPorMes);

                // Ocultar loader después de un pequeño delay para mejor UX
                setTimeout(() => {
                    loader.classList.add('hidden');
                }, 300);

            } catch (error) {
                console.error('Error:', error);
                loader.classList.add('hidden');
                alert('Error al cargar los datos del dashboard');
            }
        }

        // Actualizar estadísticas del header
        function actualizarStats(stats) {
            document.getElementById('statClientes').textContent = stats.totalClientes;
            document.getElementById('statProyectos').textContent = stats.totalProyectos;
            document.getElementById('statColaboradores').textContent = stats.totalColaboradores;
            document.getElementById('statSesionesHoy').textContent = stats.sesionesHoy;
        }

        // Gráfico 1: Sesiones por Mes
        function crearGraficoSesionesPorMes(datos) {
            if (chartSesionesMes) chartSesionesMes.destroy();

            const backgrounds = datos.meses.map((_, i) => colorArray[i % colorArray.length].bg);
            const borders = datos.meses.map((_, i) => colorArray[i % colorArray.length].border);

            chartSesionesMes = new Chart(document.getElementById('chartSesionesMes'), {
                type: 'bar',
                data: {
                    labels: datos.meses,
                    datasets: [{
                        label: 'Sesiones Completadas',
                        data: datos.cantidadSesiones,
                        backgroundColor: backgrounds,
                        borderColor: borders,
                        borderWidth: 1.5,
                        borderRadius: 6
                    }]
                },
                options: {
                    ...baseOptions,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 10 } } }
                }
            });
        }

        // Gráfico 2: Horas Trabajadas por Mes
        function crearGraficoHorasPorMes(datos) {
            if (chartHorasTrabajadas) chartHorasTrabajadas.destroy();

            chartHorasTrabajadas = new Chart(document.getElementById('chartHorasTrabajadas'), {
                type: 'line',
                data: {
                    labels: datos.meses,
                    datasets: [{
                        label: 'Horas',
                        data: datos.horas,
                        borderColor: chartColors.green.border,
                        backgroundColor: chartColors.green.bg,
                        borderWidth: 2.5,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointBackgroundColor: chartColors.green.border,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 1.5
                    }]
                },
                options: {
                    ...baseOptions,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 50 } } }
                }
            });
        }

        // Crear selector de meses dinámicamente
        function crearSelectorMeses(horasPorServicioPorMes) {
            const selector = document.getElementById('selectMesServicio');
            selector.innerHTML = '';

            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

            // Obtener los meses disponibles (keys del diccionario)
            const mesesDisponibles = Object.keys(horasPorServicioPorMes).map(Number).sort((a, b) => a - b);

            mesesDisponibles.forEach(mes => {
                const option = document.createElement('option');
                option.value = mes;
                option.textContent = meses[mes - 1];
                selector.appendChild(option);
            });

            // Seleccionar el último mes por defecto
            if (mesesDisponibles.length > 0) {
                const ultimoMes = mesesDisponibles[mesesDisponibles.length - 1];
                selector.value = ultimoMes;
                crearGraficoHorasPorServicio(ultimoMes);
            }

            // Event listener para cambio de mes
            selector.addEventListener('change', e => crearGraficoHorasPorServicio(parseInt(e.target.value)));
        }

        // Gráfico 3: Horas por Servicio (Dona con selector de mes)
        function crearGraficoHorasPorServicio(mes) {
            const datos = datosServiciosPorMes[mes];

            if (!datos || !datos.servicios || datos.servicios.length === 0) {
                // Si no hay datos, mostrar mensaje o gráfico vacío
                if (chartServiciosInstance) chartServiciosInstance.destroy();
                return;
            }

            if (chartServiciosInstance) chartServiciosInstance.destroy();

            const backgrounds = datos.servicios.map((_, i) => colorArray[i % colorArray.length].bg);

            chartServiciosInstance = new Chart(document.getElementById('chartDistribucionServicios'), {
                type: 'doughnut',
                data: {
                    labels: datos.servicios,
                    datasets: [{
                        label: 'Horas',
                        data: datos.horas,
                        backgroundColor: backgrounds,
                        borderWidth: 0
                    }]
                },
                options: {
                    ...baseOptions,
                    plugins: {
                        legend: doughnutLegend,
                        tooltip: { callbacks: percentageTooltip(' horas') }
                    }
                }
            });
        }

        // Gráfico 4: Proyectos Activos vs Finalizados
        function crearGraficoProyectosPorEstado(datos) {
            if (chartProyectosEstado) chartProyectosEstado.destroy();

            chartProyectosEstado = new Chart(document.getElementById('chartProyectosEstado'), {
                type: 'doughnut',
                data: {
                    labels: ['Activos', 'Finalizados'],
                    datasets: [{
                        label: 'Proyectos',
                        data: [datos.proyectosActivos, datos.proyectosFinalizados],
                        backgroundColor: [chartColors.green.bg, chartColors.blue.bg],
                        borderWidth: 0
                    }]
                },
                options: {
                    ...baseOptions,
                    plugins: {
                        legend: doughnutLegend,
                        tooltip: { callbacks: percentageTooltip(' proyectos') }
                    }
                }
            });
        }

        // Gráfico 5: Top 5 Clientes por Horas
        function crearGraficoTopClientes(datos) {
            if (chartTopClientes) chartTopClientes.destroy();

            if (!datos.clientes || datos.clientes.length === 0) {
                // Si no hay datos, no crear el gráfico
                return;
            }

            const backgrounds = datos.clientes.map((_, i) => colorArray[i % colorArray.length].bg);
            const borders = datos.clientes.map((_, i) => colorArray[i % colorArray.length].border);

            chartTopClientes = new Chart(document.getElementById('chartTopClientes'), {
                type: 'bar',
                data: {
                    labels: datos.clientes,
                    datasets: [{
                        label: 'Horas Totales',
                        data: datos.horas,
                        backgroundColor: backgrounds,
                        borderColor: borders,
                        borderWidth: 1.5,
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    ...baseOptions,
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: ctx => ctx.parsed.x + ' horas trabajadas' } }
                    },
                    scales: { x: { beginAtZero: true, ticks: { stepSize: 50 } } }
                }
            });
        }

        // Gráfico 6: Top 5 Colaboradores por Horas
        function crearGraficoTopColaboradores(datos) {
            if (chartTopColaboradores) chartTopColaboradores.destroy();

            if (!datos.colaboradores || datos.colaboradores.length === 0) {
                // Si no hay datos, no crear el gráfico
                return;
            }

            const backgrounds = datos.colaboradores.map((_, i) => colorArray[i % colorArray.length].bg);
            const borders = datos.colaboradores.map((_, i) => colorArray[i % colorArray.length].border);

            chartTopColaboradores = new Chart(document.getElementById('chartUtilizacionColaboradores'), {
                type: 'bar',
                data: {
                    labels: datos.colaboradores,
                    datasets: [{
                        label: 'Horas Trabajadas',
                        data: datos.horas,
                        backgroundColor: backgrounds,
                        borderColor: borders,
                        borderWidth: 1.5,
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    ...baseOptions,
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: ctx => ctx.parsed.x + ' horas trabajadas' } }
                    },
                    scales: { x: { beginAtZero: true, ticks: { stepSize: 20 } } }
                }
            });
        }

        // Inicializar dashboard al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            cargarDatosDashboard();
        });
    </script>
}